<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>sniper.io</title>
  <style>
  html, body {
    width: 100%;
    height: 100%;
  }
  body {
    background-color: #000;
    margin: 0;
    overflow: hidden;
    font-family: arial;
  }

  #progress {
    position: absolute;
    width: 50%;
    height: 10%;
    left: 25%;
    top: 45%;
    background: #000;
    border: 2px solid #000;
  }

  #progressBar {
    position: absolute;
    width: 100%;
    height: 100%;
    left: 0%;
    top: 0%;
    background: red;
    border: none;
    z-index: 0;
  }

  #progress p{
    position: relative;
    text-align: center;
    font-size: 24px;
    color: #fff;
    z-index: 10;
  }

  #blocker {
    position: absolute;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  #instructions {
    width: 100%;
    height: 100%;
    display: -webkit-box;
    display: -moz-box;
    display: box;
    -webkit-box-orient: horizontal;
    -moz-box-orient: horizontal;
    box-orient: horizontal;
    -webkit-box-pack: center;
    -moz-box-pack: center;
    box-pack: center;
    -webkit-box-align: center;
    -moz-box-align: center;
    box-align: center;
    color: #ffffff;
    text-align: center;
    cursor: pointer;
  }

  #playButton {
    position: absolute;
    top: 42.5%;
    width: 30%;
    height: 15%;
    left: 35%;
    z-index: 5000;
    background-color: #008CBA;
    border-width: 0px;
    border-color: #3e9141;
    border-style: solid;
    border-radius: 4px;
    color: white;
    font-size: 36px;
    text-decoration: none
    text-align: center;
    display: inline-block;

    -webkit-transition-duration: 0.4s;
    transition-duration: 0.4s;
  }

  #playButton:hover {
    box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19);
  }

  #nickname{
    position: absolute;
    top: 35%;
    left: 35%;
    width: 30%;
    height: 5%;
    z-index: 5000;
    border-width: 2px;
    border-color: #f9f9f9;
    border-style: solid;
    border-radius: 4px;
    color: black;
    font-size: 24px;
    text-align: left;
  }

  .chatWrapper {
    position: absolute;
    overflow: scroll;
    top: 25%;
    left: 0%;
    width: 20%;
    height: 50%;
    z-index: 5000;
    font-size: 12px;
    text-align: left;
    background: rgba(61, 61, 61, 0.5);
  }

  .chatBox {
    position: absolute;
    bottom: 0;
    left: 5%;
    width: 95%;
  }

  .chatBox div{
    word-break: break-all;
    color: #fff;
  }

  .chatField {
    position: absolute;
    top:100%;
    left: 5%;
    height: 7.5%;
    width: 95%;
    z-index: 5001;
    font-size: 12px;
    text-align: left;
    border: 0;
    outline: none;

    background: rgba(61, 61, 61, 0.85);

    color: #fff;
  }

  #canvasContainer {
    z-index: -10
  }

  #stats{
    position: absolute;
    left: 0;
    top: 0;
  }

  .playerStatWrapper {
    position: absolute;
    z-index: 5001;

    bottom: 0%;
    left: 0%;
    height: 25%;
    width: 30%;
    background: rgba(0, 0, 0, 0);
  }

  .playerStatBox {
    position: absolute;
    bottom: 0;
    left: 5%;
    width: 95%;
  }

  .playerStatBox div{
    color: #fff;
    font-size: 26px;
  }

  </style>
</head>
<body>
  <script src="http://sniper.satvik.co/socket.io/socket.io.js"></script>
  <script src="http://sniper.satvik.co/libraries/three.min.js"></script>
  <script src="http://sniper.satvik.co/libraries/OBJLoader.js"></script>
  <script src="http://sniper.satvik.co/libraries/cannon.min.js"></script>

  <script src="http://sniper.satvik.co/debug/Stats.js"></script>
  <script src="http://sniper.satvik.co/debug/CannonDebugRenderer.js"></script>

  <script src="http://sniper.satvik.co/js/assets.js"></script>
  <script src="http://sniper.satvik.co/js/loader.js"></script>
  <script src="http://sniper.satvik.co/js/lobby.js"></script>
  <script src="http://sniper.satvik.co/js/keys.js"></script>
  <script src="http://sniper.satvik.co/js/pointerlockcontrols.js"></script>
  <script src="http://sniper.satvik.co/js/stage.js"></script>
  <script src="http://sniper.satvik.co/js/multiplayer.js"></script>
  <script src="http://sniper.satvik.co/js/guns.js"></script>
  <script src="http://sniper.satvik.co/js/hud.js"></script>
  <script src="http://sniper.satvik.co/js/remotePlayer.js"></script>
  <script src="http://sniper.satvik.co/js/chat.js"></script>
  <script src="http://sniper.satvik.co/js/stats.js"></script>
  <script src="http://sniper.satvik.co/js/shooting.js"></script>


  <div id="blocker" style="z-index: 3000; display: none; ">
    <div id="instructions">
      <span style="font-size:40px; ">SNIPER.IO</span>
      <br />
      (W,A,S,D : Move, SPACE : Jump, MOUSE : Look, CLICK : Shoot, L-Shift : Scope, T: Chat)
    </div>
  </div>
<script>
var sphereShape, sphereBody//, physicsMaterial;
var cannonDebugRenderer;
var spectateCamera;
var camera, scene, renderer, raycaster;
var geometry, mesh;
// var width, height;

var controls,time = Date.now();
var blocker = document.getElementById( 'blocker' );

var dt = 1/60;

function init() {

  initPointerLock();
  initHUD();

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x00bfff)
  var ambient = new THREE.AmbientLight( 0x404040, 1 );
  scene.add( ambient );

  spectateCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
  spectateCamera.position.set(50, 60, -50)
  spectateCamera.lookAt(new THREE.Vector3(0, 0, 0))
  scene.add(spectateCamera)

  camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.001, 1000 );

  var hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
  hemiLight.color.setHSL( 0.6, 1, 0.6 );
  hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
  hemiLight.position.set( 0, 500, 0 );
  scene.add( hemiLight );

  var dirLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
  dirLight.position.set( -135, 146, 50 );
  dirLight.name = "dirlight";
  dirLight.target.position.set(0, 0, 0)

  // var shadowHelper = new THREE.CameraHelper( dirLight.shadow.camera );
  // scene.add(shadowHelper);

  var d = 200;
  dirLight.shadow.camera.left = -d;
  dirLight.shadow.camera.right = d;
  dirLight.shadow.camera.top = d;
  dirLight.shadow.camera.bottom = -d;
  scene.add( dirLight );

  dirLight.castShadow = true;
  dirLight.shadow.mapSize.width = dirLight.shadow.mapSize.height = 1024*2;
  dirLight.shadow.bias = -0.0007;

  // var helper = new THREE.DirectionalLightHelper( dirLight );
  // scene.add(helper);

  // scene.add(new THREE.Mesh(gunTest, new THREE.MeshBasicMaterial({})))
  // scene.add(gunTest)

  // floor
  geometry = new THREE.PlaneGeometry( 100, 100, 10, 10);
  geometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );
  mesh = new THREE.Mesh( geometry, floorMaterial );
  mesh.receiveShadow = true;
  scene.add( mesh );

  raycaster = new THREE.Raycaster()

  renderer = new THREE.WebGLRenderer({canvas: canvas});
  renderer.shadowMap.enabled = true;
  renderer.shadowMapSoft = true;

  renderer.setSize( window.innerWidth, window.innerHeight );

  var axisHelper = new THREE.AxisHelper( 7 );
  scene.add( axisHelper );

  window.addEventListener( 'resize', onWindowResize, false );

  remotePlayers = [];

  socket = io.connect("http://sniper.satvik.co")
  setSocketEventHandlers()
}

function initPointerLock(){
  var element = document.body

  element.requestPointerLock = element.requestPointerLock ||
                              element.mozRequestPointerLock;

  document.exitPointerLock = document.exitPointerLock ||
                             document.mozExitPointerLock;

  element.onclick = function() {
    if(inGame){
      if(chatting == false){
        element.requestPointerLock();
      }else{
        chatting = false
        chatField.style.display = "none"
        element.requestPointerLock()
      }
    }
  };

  // Hook pointer lock state change events for different browsers
  document.addEventListener('pointerlockchange', lockChangeAlert, false);
  document.addEventListener('mozpointerlockchange', lockChangeAlert, false);


  function lockChangeAlert() {
    if(inGame){
      if (document.pointerLockElement === element ||
          document.mozPointerLockElement === element) {
        // console.log('The pointer lock status is now locked');
        controls.enabled = true
        blocker.style.display = 'none';
        // document.addEventListener("mousemove", controls.onMouseMove, false);
      } else {
        // console.log('The pointer lock status is now unlocked');
        controls.enabled = false
        blocker.style.display = '-webkit-box';
        blocker.style.display = '-moz-box';
        blocker.style.display = 'box';
        // document.removeEventListener("mousemove", controls.onMouseMove, false);
      }
    }
  }
}

var angle = 0

function animate() {
  if(loaded){
    stats.begin()

    if(inGame){
      var dt = Date.now() - time
      controls.update( dt );

      var inputs = controls.inputs()

      //TODO Test if mouse moved
      // if(inputs.left || inputs.right || inputs.forward || inputs.backward || inputs.jump){
        socket.emit("move player", {id: socket.id, inputs: inputs});
      // }


      // testLatency();

      updateBullets();

      renderer.render( scene, camera );
      drawOverlay()
    }else{
      spectateCamera.position.x = 50*Math.cos(angle)
      spectateCamera.position.z = 50*Math.sin(angle)
      angle += 0.002
      spectateCamera.lookAt(new THREE.Vector3(0, 0, 0))

      renderer.render( scene, spectateCamera );
    }

    if(cannonDebugRenderer)
      // cannonDebugRenderer.update()

    stats.end()
    time = Date.now();

    requestAnimationFrame( animate );
  }
}



</script>
</body>
</html>
